<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>더베이커 직원용 페이지</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard', 'Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brown: '#6B4423',
                        black: '#111111',
                        white: '#FFFFFF',
                        cream: '#f9f7f2',
                        danger: '#ff4444',
                        success: '#00cc66'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-cream text-black font-sans h-screen flex flex-col overflow-hidden">

    <header class="h-14 border-b border-black flex justify-between items-center px-6 bg-white shrink-0">
        <div class="flex items-center space-x-4">
            <button id="statusBtn" onclick="toggleShop()" class="flex items-center space-x-2 px-3 py-1 rounded-full border border-transparent hover:border-black transition">
                <div id="statusDot" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                <span id="statusText" class="text-xs font-bold tracking-[0.2em] uppercase">로딩중...</span>
            </button>
        </div>
        <div class="font-mono text-xs" id="clock">--:--</div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <section class="flex-1 overflow-y-auto p-6">
            <div class="flex justify-between items-end mb-6">
                <h2 class="text-2xl font-bold tracking-tight">현재 재고</h2>
                <button onclick="loadInventory()" class="text-[10px] uppercase tracking-widest border border-black px-3 py-1 hover:bg-black hover:text-white transition">
                    Refresh
                </button>
            </div>

            <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                </div>
        </section>

        <aside class="w-80 border-l border-black bg-white flex flex-col">
            
            <div class="p-6 border-b border-black">
                <h3 class="text-xs font-bold tracking-tight uppercase text-gray-500 mb-4">포인트 적립</h3>
                
                <div class="space-y-3">
                    <input type="tel" id="phone" placeholder="핸드폰 번호 (010...)" class="w-full bg-gray-50 border border-gray-200 p-3 text-sm font-sans focus:border-black focus:outline-none rounded-sm">
                    <input type="number" id="amount" placeholder="구매금액 (₩)" class="w-full bg-gray-50 border border-gray-200 p-3 text-sm font-sans focus:border-black focus:outline-none rounded-sm">
                    
                    <button onclick="addPoints()" class="w-full bg-brown text-white py-3 text-base font-bold uppercase tracking-widest hover:bg-gray-800 transition rounded-sm">
                        확인
                    </button>
                    
                    <p id="pointMsg" class="text-center text-xs font-mono h-4 text-success"></p>
                </div>
            </div>

            <div class="flex-1 p-4 bg-gray-50">
                <h3 class="text-xs font-bold tracking-[0.2em] uppercase text-gray-400 mb-4">시스템 기록</h3>
                <div id="logs" class="space-y-2">
                    </div>
            </div>
        </aside>

    </main>

    <script>
        // --- 1. CLOCK ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // --- 2. STATUS LOGIC ---
        async function loadStatus() {
            try {
                const res = await fetch('/api/staff/status');
                const data = await res.json();
                updateStatusUI(data.open);
            } catch(e) { console.error("API Error"); }
        }

        async function toggleShop() {
            const btnText = document.getElementById('statusText').innerText;
            const isCurrentlyOpen = btnText.includes("OPEN");
            
            try {
                const res = await fetch('/api/staff/status', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ open: !isCurrentlyOpen })
                });
                updateStatusUI(!isCurrentlyOpen);
            } catch(e) { alert("Error connecting to server"); }
        }

        function updateStatusUI(isOpen) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if(isOpen) {
                text.innerText = "OPEN";
                dot.classList.remove('bg-danger', 'bg-gray-400');
                dot.classList.add('bg-success', 'animate-pulse');
            } else {
                text.innerText = "CLOSED";
                dot.classList.remove('bg-success', 'animate-pulse');
                dot.classList.add('bg-danger');
            }
        }

        // --- 3. INVENTORY LOGIC (Grid Version) ---
        async function loadInventory() {
            try {
                const res = await fetch('/api/products');
                const products = await res.json();
                renderGrid(products);
            } catch(e) { console.error("Inventory Error"); }
        }

        function renderGrid(products) {
            const container = document.getElementById('inventory-grid');
            container.innerHTML = products.map(p => `
                <div class="bg-white border border-gray-200 p-4 flex flex-col justify-between h-32 relative group hover:border-black transition shadow-sm">
                    <div class="flex justify-between items-start">
                        <span class="text-sm font-bold leading-tight">${p.name}</span>
                        <span class="font-mono text-xl font-bold" id="display-${p.id}">${p.stockQuantity}</span>
                    </div>
                    
                    <div class="flex space-x-2 mt-auto opacity-50 group-hover:opacity-100 transition">
                        <input type="number" id="input-${p.id}" value="${p.stockQuantity}" class="hidden"> 
                        <button onclick="quickUpdate(${p.id}, -1)" class="flex-1 bg-gray-100 hover:bg-brown hover:text-white text-xs py-2 rounded">-</button>
                        <button onclick="quickUpdate(${p.id}, 1)" class="flex-1 bg-gray-100 hover:bg-brown hover:text-white text-xs py-2 rounded">+</button>
                    </div>
                </div>
            `).join('');
        }

        // Quick Update (+/- buttons)
        async function quickUpdate(id, change) {
            const display = document.getElementById(`display-${id}`);
            let currentVal = parseInt(display.innerText);
            let newVal = currentVal + change;
            if(newVal < 0) newVal = 0;

            // Optimistic UI Update (Instant feel)
            display.innerText = newVal;

            // Send to Server
            await fetch('/api/staff/stock', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ productId: id, quantity: newVal })
            });
            
            // Log it
            addLog(`${change > 0 ? 'Restocked' : 'Sold'} Product #${id}`);
        }

        // --- 4. POINTS LOGIC ---
        async function addPoints() {
            const phone = document.getElementById('phone').value;
            const amount = document.getElementById('amount').value;
            const msg = document.getElementById('pointMsg');

            if(!phone || !amount) return;

            try {
                const res = await fetch('/api/staff/points', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ phoneNumber: phone, amount: amount })
                });
                const data = await res.json();
                
                if (res.ok) {
                    msg.innerText = `Success: +${data.added} pts`;
                    addLog(`Points added to ${phone.substring(7)}`);
                    document.getElementById('amount').value = '';
                    document.getElementById('phone').value = '';
                    
                    setTimeout(() => msg.innerText = '', 3000);
                }
            } catch(e) { msg.innerText = "Error!"; }
        }

        function addLog(text) {
            const logs = document.getElementById('logs');
            const now = new Date().toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'});
            logs.insertAdjacentHTML('afterbegin', `
                <div class="text-[10px] text-gray-500 font-mono border-l-2 border-black pl-2 mb-2">
                    <span class="opacity-50">${now}</span> ${text}
                </div>
            `);
        }

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            loadInventory();
        });
    </script>
</body>
</html>