<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE BAKER - Reservation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Arial', 'sans-serif'],
                        serif: ['Pretendard', 'sans-serif'],
                        nav: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brown: '#6B4423',
                        black: '#111111',
                        white: '#FFFFFF',
                        gray: '#F4F4F4',
                        cream: '#f9f7f2',
                        success: '#22c55e',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Regular.woff2') format('woff2'); font-weight: 400; font-display: swap; }
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-SemiBold.woff2') format('woff2'); font-weight: 600; font-display: swap; }
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Bold.woff2') format('woff2'); font-weight: 700; font-display: swap; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        html {
            overflow-y: scroll;
        }
    </style>
</head>
<body class="bg-white text-brown font-sans antialiased">

<nav class="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md border-b border-black/5">
    <div class="max-w-screen-xl mx-auto px-4 md:px-6 h-16 flex justify-between items-center">

        <a href="index.html" class="text-[20px] md:text-[24px] font-semibold tracking-tight hover:opacity-70 transition">THE BAKER</a>

        <div class="flex space-x-4 md:space-x-8 text-[14px] md:text-[15px] font-bold tracking-tight md:tracking-wider">
            <a href="about.html" class="hover:text-brown transition">소개</a>
            <a href="menu.html" class="hover:text-brown transition">메뉴</a>
            <a href="reservation.html" class="hover:text-brown transition">예약</a>
        </div>
    </div>
</nav>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const path = window.location.pathname;
        if (path.includes("about")) document.getElementById("link-about").classList.add("opacity-50", "pointer-events-none");
        else if (path.includes("menu")) document.getElementById("link-menu").classList.add("opacity-50", "pointer-events-none");
        else if (path.includes("reservation")) document.getElementById("link-reservation").classList.add("opacity-50", "pointer-events-none");
    });
</script>

<main class="pt-32 pb-24 px-6 max-w-screen-xl mx-auto">
    <h1 class="text-3xl font-bold mb-8 tracking-[-0.03em] uppercase">당일 예약</h1>

    <div class="space-y-6 mb-12 pb-12">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-[14px] font-bold mb-2 uppercase tracking-wide text-gray-400">픽업 날짜</label>
                <input type="date" id="datePicker" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-sm font-bold text-black focus:border-brown focus:outline-none">            </div>
            <div>
                <label class="block text-[14px] font-bold mb-2 uppercase tracking-wide text-gray-400">시간</label>
                <select class="w-full bg-gray-50 border border-gray-200 p-3 rounded-sm font-bold text-black focus:border-brown focus:outline-none">
                    <option>11:00 AM</option>
                    <option>12:00 PM</option>
                    <option>1:00 PM</option>
                    <option>2:00 PM</option>
                    <option>3:00 PM</option>
                    <option>4:00 PM</option>
                </select>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <input type="text" id="custName" placeholder="성함" class="w-full border-b border-gray-300 py-2 focus:outline-none focus:border-black transition">
            <input type="tel" id="custPhone" placeholder="핸드폰 번호" class="w-full border-b border-gray-300 py-2 focus:outline-none focus:border-black transition">
        </div>
    </div>

    <div class="mb-12">
        <h3 class="text-xl font-bold mb-6">메뉴</h3>
        <div id="menu-list" class="space-y-4">
            <div class="text-gray-400 text-sm">메뉴를 보시기 위해 날짜를 선택해주세요.</div>
        </div>
    </div>

    <div class="bg-gray-50 p-6 rounded-lg">
        <div class="flex justify-between items-center mb-6">
            <span class="text-xl font-bold uppercase tracking-wide text-gray-400">총 금액</span>
            <span class="text-2xl font-black text-black" id="totalPrice">0 원</span>
        </div>
        <div class="flex items-start space-x-3 mb-6 bg-yellow-50 p-4 border border-yellow-100 rounded">
            <input type="checkbox" id="marketingConsent" class="mt-1 w-4 h-4 accent-brown">
            <label for="marketingConsent" class="text-xs text-gray-600 leading-tight">
                <span class="font-bold text-brown uppercase block mb-1">마케팅 수신 동의</span>
                더베이커 마케팅 수신에 동의하시면 체크해주세요.
            </label>
        </div>
        <button onclick="openPayment()" class="w-full bg-brown text-white py-4 text-sm font-bold uppercase tracking-widest hover:bg-black transition">
            예약 완료하기
        </button>
        <p class="text-[16px] text-gray-400 mt-4 text-center">
            * 20개 제품 이상의 대량 주문이실 경우에는 더베이커로 직접 연락 부탁드립니다.
        </p>
    </div>
</main>

<footer class="bg-white py-12 px-6 border-t border-gray-100 mt-auto">
    <div class="max-w-screen-xl mx-auto flex flex-col md:flex-row justify-between items-center text-[13px] uppercase tracking-wide text-gray-400">
        <p class="font-bold tracking-tight">&copy; 2026 THE BAKER DAEJEON</p>
    </div>
</footer>

<div id="bank-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="relative bg-white w-full max-w-sm mx-6 p-8 shadow-2xl">
        <h3 class="text-xl font-bold mb-6 tracking-tight text-black">입금 계좌</h3>
        <div class="space-y-4 mb-8 text-black">
            <div class="p-4 bg-gray-50 border border-gray-100">
                <p class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">은행</p>
                <p class="text-lg font-bold">국민은행</p>
            </div>
            <div class="p-4 bg-gray-50 border border-gray-100 group cursor-pointer" onclick="copyAccount()">
                <p class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">계좌번호</p>
                <p class="text-lg font-mono font-bold" id="account-num">1234-56-789012</p>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                <span class="text-sm font-bold text-gray-400">입금하실 금액</span>
                <span class="text-xl font-black text-brown" id="modalTotal">0</span>
            </div>
        </div>
        <button onclick="finishReservation()" class="w-full bg-brown text-white py-4 text-sm font-bold uppercase tracking-widest hover:bg-black transition">입금을 완료하신 후 클릭해주세요.</button>
        <button onclick="closeModal()" class="w-full mt-4 text-xs font-bold uppercase tracking-widest text-gray-400">취소하기</button>
    </div>
</div>

<script>
        // --- SMART DATE LOGIC ---
        const dateInput = document.getElementById('datePicker');

        // 1. Set MIN Date (Today)
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.min = `${yyyy}-${mm}-${dd}`;

        // 2. Set MAX Date (Next 14 Days)
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 14);
        dateInput.max = maxDate.toISOString().split("T")[0];

        // 3. Set Default Date (Tomorrow, Skip Tuesday)
        let defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 1);
        while(defaultDate.getDay() === 2) { // If Tuesday (2), skip to Wednesday
            defaultDate.setDate(defaultDate.getDate() + 1);
        }
        dateInput.valueAsDate = defaultDate;

        // 4. EVENT LISTENER (Blocks Tuesday & Updates Menu)
        dateInput.addEventListener('change', function() {
            const selected = new Date(this.value);
            if(selected.getDay() === 2) { // 2 = Tuesday
                alert("죄송합니다. 화요일은 정기 휴무일입니다.\n(We are closed on Tuesdays.)");
                this.value = ""; // Clear the input
                document.getElementById('menu-list').innerHTML = ''; // Clear menu
                document.getElementById('totalPrice').innerText = "0 원";
                cart = {}; // Reset cart
            } else {
                fetchMenuForDate(); // Load menu if valid
            }
        });

        // Store current cart state { productId: quantity }
        let cart = {};
        let productData = []; // Store fetched products to look up prices later

        async function fetchMenuForDate() {
            const date = dateInput.value;
            if(!date) return;

            // Reset Cart
            cart = {};
            updateTotal();

            const list = document.getElementById('menu-list');
            list.innerHTML = '<div class="animate-pulse text-gray-300">Checking Menu...</div>';

            try {
                // Call Backend with ?date=YYYY-MM-DD
                const res = await fetch(`/api/products?date=${date}`);
                productData = await res.json();

                list.innerHTML = '';

                if(productData.length === 0) {
                    list.innerHTML = '<div class="text-red-400 font-bold">Sorry, we are closed on this day.</div>';
                    return;
                }

                // Render Items
                productData.forEach(p => {
                    const priceFmt = new Intl.NumberFormat('ko-KR').format(p.price);

                    const itemHTML = `
                        <div class="flex justify-between items-center border border-gray-100 p-4 rounded-lg bg-white shadow-sm">
                            <div>
                                <h4 class="font-bold text-lg">${p.name}</h4>
                                <p class="text-sm text-gray-500">₩${priceFmt}</p>
                            </div>

                            <div class="flex items-center space-x-3">
                                <button onclick="updateQty(${p.id}, -1)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 font-bold">-</button>
                                <span id="qty-${p.id}" class="w-4 text-center font-bold">0</span>
                                <button onclick="updateQty(${p.id}, 1)" class="w-8 h-8 rounded-full bg-black text-white hover:bg-brown font-bold">+</button>
                            </div>
                        </div>
                    `;
                    list.insertAdjacentHTML('beforeend', itemHTML);
                });

            } catch(e) {
                console.error(e);
                list.innerHTML = 'Error loading menu.';
            }
        }

        function updateQty(id, change) {
            if(!cart[id]) cart[id] = 0;
            cart[id] += change;
            if(cart[id] < 0) cart[id] = 0;

            // Update UI Number
            document.getElementById(`qty-${id}`).innerText = cart[id];
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            // Loop through cart and find price from productData
            for (const [id, qty] of Object.entries(cart)) {
                const product = productData.find(p => p.id == id);
                if(product) {
                    total += product.price * qty;
                }
            }

            const fmt = new Intl.NumberFormat('ko-KR').format(total) + " 원";
            document.getElementById('totalPrice').innerText = fmt;
            document.getElementById('modalTotal').innerText = fmt; // Update Modal too
        }

        // Initialize
        fetchMenuForDate(); // Load tomorrow's menu on start

        // Payment Logic
        function openPayment() {
            const name = document.getElementById('custName').value;
            const totalText = document.getElementById('totalPrice').innerText;

            // Basic validation
            if(!name) { alert("성함을 적어주세요."); return; }
            if(totalText === "0 원") { alert("최소 한 개 이상의 제품을 선택해주세요."); return; }

            document.getElementById('bank-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('bank-modal').classList.add('hidden'); }
        function copyAccount() {
            navigator.clipboard.writeText("1234-56-789012");
            alert("Copied!");
        }

        async function finishReservation() {
            const name = document.getElementById('custName').value;
            const phone = document.getElementById('custPhone').value;
            const consent = document.getElementById('marketingConsent').checked;

            // 1. Build the Item List from the Cart
            const items = [];
            for (const [id, qty] of Object.entries(cart)) {
                if (qty > 0) {
                    items.push({ productId: parseInt(id), quantity: qty });
                }
            }

            if (items.length === 0) {
                alert("Cart is empty!");
                return;
            }

            // 2. Create the Payload
            const payload = {
                customerName: name,
                phoneNumber: phone,
                marketingConsent: consent,
                items: items
            };

            // 3. Send to Backend
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("예약이 성공적으로 접수되었습니다! (Order Received)");
                    location.href = "index.html";
                } else {
                    alert("Order failed. Please try again.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Server error.");
            }
        }
</script>

</body>
</html>