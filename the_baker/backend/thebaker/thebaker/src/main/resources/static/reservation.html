<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE BAKER - ì˜ˆì•½</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F54HS1GX0M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-F54HS1GX0M');
    </script>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "v5bcs3qciu");
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Arial', 'sans-serif'],
                        serif: ['Pretendard', 'sans-serif'],
                        nav: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brown: '#6B4423',
                        darkbrown: '#47280e',
                        black: '#111111',
                        white: '#FFFFFF',
                        gray: '#F4F4F4',
                        cream: '#f9f7f2',
                        success: '#22c55e',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Regular.woff2') format('woff2'); font-weight: 400; font-display: swap; }
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-SemiBold.woff2') format('woff2'); font-weight: 600; font-display: swap; }
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Bold.woff2') format('woff2'); font-weight: 700; font-display: swap; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        html {
            overflow-y: scroll;
        }
    </style>
</head>
<body class="bg-white text-brown font-sans antialiased">

<nav class="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md border-b border-black/5">
    <div class="max-w-screen-xl mx-auto px-4 md:px-6 h-16 flex justify-between items-center">

        <a href="index.html" class="text-[20px] md:text-[24px] font-semibold tracking-tight hover:opacity-70 transition">THE BAKER</a>

        <div class="flex space-x-4 md:space-x-8 text-[14px] md:text-[15px] font-bold tracking-tight md:tracking-wider">
            <a href="about.html" class="hover:text-brown transition">ì†Œê°œ</a>
            <a href="menu.html" class="hover:text-brown transition">ë©”ë‰´</a>
            <a href="reservation.html" class="hover:text-brown transition">ì˜ˆì•½</a>
        </div>
    </div>
</nav>


<main class="pt-32 pb-24 px-6 max-w-screen-xl mx-auto flex flex-col items-center justify-center min-h-[60vh] text-center">

    <div class="bg-orange-50 p-6 rounded-full mb-8">
        <span class="text-6xl">ğŸš§</span>
    </div>

    <h1 class="text-3xl md:text-4xl font-bold mb-4">ì˜ˆì•½ ì‹œìŠ¤í…œ ì˜¤í”ˆ ì˜ˆì •</h1>

    <p class="text-gray-500 text-lg mb-8">
        ë‹¹ì¼ ì˜ˆì•½ ì‹œìŠ¤í…œì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤. ì—´ì‹¬íˆ ì¤€ë¹„í•´ì„œ ê³§ ì˜¤í”ˆí•˜ê² ìŠµë‹ˆë‹¤.
    </p>

    <a href="menu.html" class="bg-black text-white px-8 py-3 rounded-full font-bold hover:opacity-80 transition">
        ì˜¤ëŠ˜ì˜ ë©”ë‰´ ë³´ê¸°
    </a>

</main>


<footer class="bg-white py-12 px-6 mt-auto">
    <div class="max-w-screen-xl mx-auto flex flex-col md:flex-row justify-between items-center text-[13px] uppercase tracking-wide text-gray-400">
        <p class="font-bold tracking-tight">&copy; 2026 THE BAKER DAEJEON</p>
        <div class="space-x-6 mt-4 md:mt-0 font-bold">
            <a href="#">ì¸ìŠ¤íƒ€ê·¸ë¨</a>
            <a href="/privacy">ê°œì¸ì •ë³´</a>
        </div>
    </div>
</footer>

<div id="bank-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="relative bg-white w-full max-w-sm mx-6 p-8 shadow-2xl">
        <h3 class="text-xl font-bold mb-6 tracking-tight text-black">ì…ê¸ˆ ê³„ì¢Œ</h3>
        <div class="space-y-4 mb-8 text-black">
            <div class="p-4 bg-gray-50 border border-gray-100">
                <p class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">ì€í–‰</p>
                <p class="text-lg font-bold">í•˜ë‚˜ì€í–‰ (ê¹€í˜„ê· )</p>
            </div>
            <div class="p-4 bg-gray-50 border border-gray-100 group cursor-pointer" onclick="copyAccount()">
                <p class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">ê³„ì¢Œë²ˆí˜¸</p>
                <p class="text-xl font-mono font-bold" id="account-num">907-910327-61107</p>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                <span class="text-sm font-bold text-gray-400">ì…ê¸ˆí•˜ì‹¤ ê¸ˆì•¡</span>
                <span class="text-xl font-black text-brown" id="modalTotal">0</span>
            </div>
        </div>
        <button onclick="finishReservation()" class="w-full bg-brown text-white py-4 text-sm font-bold uppercase tracking-wide hover:bg-black transition">ì…ê¸ˆì„ ì™„ë£Œí•˜ì‹  í›„ í´ë¦­í•´ì£¼ì„¸ìš”.</button>
        <button onclick="closeModal()" class="w-full mt-4 text-xs font-bold uppercase tracking-widest text-gray-400">ì·¨ì†Œí•˜ê¸°</button>
    </div>
</div>

<script>
    // --- 1. DATE DISPLAY (Keep this) ---
    document.getElementById('displayDate').innerText = new Date().toLocaleDateString('ko-KR', {
        year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
    });

    // --- 2. GLOBAL VARIABLES ---
    let cart = {};
    let productData = []; // Stores live stock data

    // --- 3. FETCH MENU & SHOW STOCK (New Logic) ---
    async function fetchMenuForDate() {
        const list = document.getElementById('menu-list');
        list.innerHTML = '<div class="animate-pulse text-gray-300">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>';

        try {
            // Fetch Live Stock (No date parameter needed anymore)
            const res = await fetch(`/api/products`);
            productData = await res.json();

            productData.sort((a, b) => {
                // 1. Define what counts as "Coffee/Drink"
                // Add any keyword that identifies a drink in your menu
                const drinkKeywords = ["ë¼ë–¼", "ì•„ë©”ë¦¬ì¹´ë…¸"];

                const isDrinkA = drinkKeywords.some(k => a.name.includes(k));
                const isDrinkB = drinkKeywords.some(k => b.name.includes(k));

                // 2. Separate Drinks from Bread
                // If A is Drink and B is Bread -> A goes down (1)
                if (isDrinkA && !isDrinkB) return 1;
                // If A is Bread and B is Drink -> A goes up (-1)
                if (!isDrinkA && isDrinkB) return -1;

                // 3. Sort by Stock (Descending)
                // If both are Bread (or both Drinks), sort by Quantity
                return b.stockQuantity - a.stockQuantity;
            });

            list.innerHTML = '';

            if(productData.length === 0) {
                list.innerHTML = '<div class="text-red-400 font-bold">í˜„ì¬ ì˜ˆì•½ ê°€ëŠ¥í•œ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // Render Items
            productData.forEach(p => {
                const priceFmt = new Intl.NumberFormat('ko-KR').format(p.price);

                // LOGIC: Check Stock
                const isSoldOut = p.stockQuantity <= 0;
                const stockText = isSoldOut ? '(í’ˆì ˆ - Sold Out)' : `(${p.stockQuantity}ê°œ ë‚¨ìŒ)`;
                const btnDisabled = isSoldOut ? 'disabled class="w-8 h-8 rounded-full bg-gray-200 text-gray-400 cursor-not-allowed"' : 'class="w-8 h-8 rounded-full bg-black text-white hover:bg-brown font-bold"';
                const opacity = isSoldOut ? 'opacity-50' : '';

                const itemHTML = `
                    <div class="flex justify-between items-center border border-gray-100 p-4 rounded-lg bg-white shadow-sm ${opacity}">
                        <div>
                            <h4 class="font-bold text-lg">${p.name}</h4>
                            <p class="text-sm text-gray-500">â‚©${priceFmt} <span class="text-red-500 text-xs font-bold">${stockText}</span></p>
                        </div>

                        <div class="flex items-center space-x-3">
                            <button onclick="updateQty(${p.id}, -1)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 font-bold">-</button>
                            <span id="qty-${p.id}" class="w-4 text-center font-bold">0</span>
                            <button onclick="updateQty(${p.id}, 1)" ${btnDisabled}>+</button>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', itemHTML);
            });

        } catch(e) {
            console.error(e);
            list.innerHTML = 'Error loading menu.';
        }
    }

    // --- 4. UPDATE QUANTITY (With Protection) ---
    function updateQty(id, change) {
        if(!cart[id]) cart[id] = 0;

        // FIND PRODUCT TO CHECK LIMIT
        const product = productData.find(p => p.id === id);

        // IF ADDING (+), CHECK STOCK LIMIT
        if (change > 0) {
            if (cart[id] >= product.stockQuantity) {
                alert(`ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ ê°€ ${product.stockQuantity}ê°œë§Œ ìˆìŠµë‹ˆë‹¤.`);
                return; // STOP! Do not add.
            }
        }

        cart[id] += change;
        if(cart[id] < 0) cart[id] = 0;

        // Update UI Number
        document.getElementById(`qty-${id}`).innerText = cart[id];
        updateTotal();
    }

    // --- 5. UPDATE TOTAL ---
    function updateTotal() {
        let total = 0;
        for (const [id, qty] of Object.entries(cart)) {
            const product = productData.find(p => p.id == id);
            if(product) {
                total += product.price * qty;
            }
        }
        const fmt = new Intl.NumberFormat('ko-KR').format(total) + " ì›";
        document.getElementById('totalPrice').innerText = fmt;

        // Update Modal Total if exists
        const modalTotal = document.getElementById('modalTotal');
        if(modalTotal) modalTotal.innerText = fmt;
    }

    // --- 6. MODAL UTILS ---
    function openPayment() {
        const name = document.getElementById('custName').value;
        const totalText = document.getElementById('totalPrice').innerText;

        if(!name) { alert("ì„±í•¨ì„ ì ì–´ì£¼ì„¸ìš”."); return; }
        if(totalText === "0 ì›") { alert("ìµœì†Œ í•œ ê°œ ì´ìƒì˜ ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

        document.getElementById('bank-modal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('bank-modal').classList.add('hidden'); }

    function copyAccount() {
        navigator.clipboard.writeText("1234-56-789012");
        alert("ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    // --- 7. FINISH RESERVATION (SAFE VERSION) ---
    async function finishReservation() {
        console.log("Submit button clicked..."); // Debug log

        try {
            // 1. Safe Value Extraction (Prevents crashes if IDs are missing)
            const nameEl = document.getElementById('custName');
            const phoneEl = document.getElementById('custPhone');
            const pickupEl = document.getElementById('pickup-time');
            const takeawayEl = document.getElementById('optTakeaway');
            const cutEl = document.getElementById('optCut');
            const memoEl = document.getElementById('orderMemo');
            const consentEl = document.getElementById('marketingConsent');

            // Validation: Check if critical elements exist
            if (!nameEl || !phoneEl) {
                alert("ì—ëŸ¬: ì´ë¦„ì´ë‚˜ í•¸ë“œí° ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const name = nameEl.value;
            const phone = phoneEl.value;
            const memo = memoEl ? memoEl.value : "";
            const consent = consentEl ? consentEl.checked : false;

            // SAFE FALLBACKS: If element is missing, default to false/default string
            const pickupTime = pickupEl ? pickupEl.value : "12:00 PM";
            const isTakeawayVal = takeawayEl ? takeawayEl.checked : false;
            const wantsCutVal = cutEl ? cutEl.checked : false;

            // 2. Build Items
            const items = [];
            if (typeof cart !== 'undefined') {
                for (const [id, qty] of Object.entries(cart)) {
                    if (qty > 0) items.push({ productId: parseInt(id), quantity: qty });
                }
            }

            if (items.length === 0) {
                alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            // 3. Payload (Using "takeaway" key for Java)
            const payload = {
                customerName: name,
                phoneNumber: phone,
                items: items,
                pickupTime: pickupTime,
                memo: memo,
                marketingConsent: consent,
                takeaway: isTakeawayVal,
                wantsCut: wantsCutVal
            };

            console.log("Sending Payload:", payload); // Verify data in Console

            // 4. Send to Backend
            const res = await fetch('/api/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
                location.reload();
            } else {
                const errorText = await res.text();
                alert("Reservation Failed: " + errorText);
            }

        } catch (e) {
            console.error("Critical Error:", e);
            alert("System Error: " + e.message);
        }
    }

    // --- 8. INITIALIZE ---
    fetchMenuForDate();

    // --- 9. Navigation Highlight ---
    document.addEventListener("DOMContentLoaded", () => {
        const path = window.location.pathname;
        if (path.includes("about")) document.getElementById("link-about").classList.add("opacity-50", "pointer-events-none");
        else if (path.includes("menu")) document.getElementById("link-menu").classList.add("opacity-50", "pointer-events-none");
        else if (path.includes("reservation")) document.getElementById("link-reservation").classList.add("opacity-50", "pointer-events-none");
    });

    // --- 10. PWA INSTALLATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('App Ready: Service Worker registered');
                })
                .catch(err => {
                    console.log('App Error: Service Worker failed', err);
                });
        });
    }
</script>

</body>
</html>